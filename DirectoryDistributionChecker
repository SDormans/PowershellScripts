<#
.SYNOPSIS
    Generates a size and file-extension report for a directory and all subdirectories.

.DESCRIPTION
    - Validates that the provided path exists
    - Recursively scans directories
    - Calculates total size in MB
    - Lists unique file extensions per directory
    - Outputs a CLI-friendly table sorted by size
#>

#region Parameters and Validation

param (
    [Parameter(Mandatory = $true)]
    [string]$Path
)

# Ensure the provided path exists
if (-not (Test-Path -Path $Path)) {
    Write-Error "The specified path does not exist: $Path"
    exit 1
}

#endregion Parameters and Validation

#region Functions

function Get-DirectoryReport {
    <#
    .SYNOPSIS
        Creates a report object for a single directory.
    #>

    param (
        [Parameter(Mandatory = $true)]
        [string]$Directory
    )

    # Retrieve all files recursively (ignore access errors)
    $files = Get-ChildItem -Path $Directory -Recurse -File -ErrorAction SilentlyContinue

    # Handle empty directories
    if (-not $files) {
        return [PSCustomObject]@{
            Directory  = $Directory
            SizeMB     = 0
            Extensions = "-"
        }
    }

    # Calculate total directory size in MB
    $sizeMB = [Math]::Round(
        ($files | Measure-Object -Property Length -Sum).Sum / 1MB,
        2
    )

    # Collect unique file extensions
    $extensions = $files |
        Where-Object { $_.Extension } |
        Select-Object -ExpandProperty Extension |
        Sort-Object -Unique

    # Return structured report object
    [PSCustomObject]@{
        Directory  = $Directory
        SizeMB     = $sizeMB
        Extensions = ($extensions -join ", ")
    }
}

#endregion Functions

#region Directory Collection

# Get all subdirectories plus the root directory itself
$directories = Get-ChildItem -Path $Path -Directory -Recurse -ErrorAction SilentlyContinue
$directories = @($Path) + $directories.FullName

#endregion Directory Collection

#region Report Generation

# Generate a report for each directory
$report = foreach ($dir in $directories) {
    Get-DirectoryReport -Directory $dir
}

#endregion Report Generation

#region Output

# Display results in a readable table sorted by size
$report |
    Sort-Object SizeMB -Descending |
    Format-Table -AutoSize

#endregion Output
